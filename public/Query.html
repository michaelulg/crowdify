<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- SEO Meta Tags -->
  <meta name="description"
    content="Crowdify is a platform that extends Spotify's abilities using crowdsourcing mechanisms">
  <meta name="author" content="Crowdify">

  <!-- Webpage Title -->
  <title>Crowdify - Query</title>

  <!-- Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link href="css/bootstrap.css" rel="stylesheet">
  <link href="css/fontawesome-all.min.css" rel="stylesheet">
  <link href="css/swiper.css" rel="stylesheet">
  <link href="css/magnific-popup.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">

  <!-- Favicon  -->
  <link rel="icon" href="images/logo_circle.png">
  <script src="https://kit.fontawesome.com/6f246cdb03.js" crossorigin="anonymous"></script>
</head>

<body data-spy="scroll" data-target=".fixed-top">

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container">
            
            <!-- Text Logo - Use this if you don't have a graphic logo -->
            <!-- <a class="navbar-brand logo-text page-scroll" href="index.html">Leon</a> -->

            <!-- Image Logo -->
            <a class="navbar-brand logo-image" href="index.html"><img src="images/logo_circle.png" alt="alternative"></a> 

            <button class="navbar-toggler p-0 border-0" type="button" data-toggle="offcanvas">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="navbar-collapse offcanvas-collapse" id="navbarsExampleDefault">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link page-scroll" href="/About">About<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a id="Query" class="nav-link page-scroll">Query</a>
                    </li>
                    <li class="nav-item">
                        <a id="Game" class="nav-link page-scroll">Game</a>
                    </li>
                    <script>
                        function getHashParams() {
                            var hashParams = {};
                            var e, r = /([^&;=]+)=?([^&;]*)/g,
                                q = window.location.hash.substring(1);
                            while ( e = r.exec(q)) {
                            hashParams[e[1]] = decodeURIComponent(e[2]);
                            }
                            return hashParams;
                        }
                        var params = getHashParams();
                        var access_token = params.access_token;
                        var refresh_token = params.refresh_token;
                        var game = document.getElementById("Game");
                        game.setAttribute("onclick","location.href='/Game?access_token="+access_token+"&refresh_token="+refresh_token+"';");
                        var query = document.getElementById("Query");
                        query.setAttribute("onclick","location.href='/Query#access_token="+access_token+"&refresh_token="+refresh_token+"';");
                    </script>
                    <li class="nav-item">
                        <a class="nav-link page-scroll" href="/Contact">Contact</a>
                    </li>
                </ul>
                <span class="nav-item">
                    <a class="btn-outline-sm page-scroll" href="/">Home</a>
                </span>
            </div> <!-- end of navbar-collapse -->
        </div> <!-- end of container -->
    </nav> <!-- end of navbar -->
  <!-- end of navigation -->

  <div id="login">
    <header id="header" class="header">
      <div class="container">
        <div class="row">
          <div class="col-lg-6">
            <div class="text-container">
              <h1 class="h1-large">Welcome to Crowdify</h1>
              <!--<span id="js-rotating">designers, developers, marketers</span> -->
              <p class="p-large">Crowdify allows you to search songs in Spotify's database, using only <span
                  id="js-rotating">lyrics, themes, vibes, associations</span> </p>
              <a class="btn-solid-lg" href="/login"><i class="fab fa-spotify fa-lg"></i></i> Log in to Spotify</a>
            </div> <!-- end of text-container -->
          </div> <!-- end of col -->
          <div class="col-lg-6">
            <div class="image-container">
              <img class="img-fluid" src="images/logo_circle.png" alt="alternative">
            </div> <!-- end of image-container -->
          </div> <!-- end of div -->
        </div> <!-- end of row -->
      </div> <!-- end of container -->
    </header>
  </div>
  <!-- end of description -->

  <!-- Features -->
  <div id="loggedin">
    <div id="features" class="tabs">
      <div class="container">
        <div class="row">
          <div class="col-lg-6">


          </div>
        </div>
      </div>
      <div class="container">
        <div class="row">
          <div class="col-lg-11">
            <h2>Welcome to the Query page!</h2>
            <h6>Here you can help crowdify grow..</h6>
          </div> <!-- end of col -->
        </div> <!-- end of row -->
        <div class="row">

          <!-- Tabs Links -->
          <ul class="nav nav-tabs" id="templateTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="nav-tab-1" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1"
                aria-selected="true"><i class="far fa-comment-dots"></i> Query</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-tab-2" data-toggle="tab" href="#tab-2" role="tab" aria-controls="tab-2"
                aria-selected="false"><i class="fas fa-list-ul"></i>List</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-tab-3" data-toggle="tab" href="#tab-3" role="tab" aria-controls="tab-3"
                aria-selected="false"><i class="fas fa-trophy"></i>Leaderboard</a>
            </li>
          </ul>
          <!-- end of tabs links -->


          <!-- Tabs Content-->
          <div class="tab-content" id="templateTabsContent">

            <!-- Tab -->
            <div class="tab-pane fade show active" id="tab-1" role="tabpanel" aria-labelledby="tab-1">
              <div class="container">
                <div id="user-profile">
                </div>
                <div class="text-container-btn">
                  <button class="btn-solid-reg page-scroll" id="pick-new-song">Pick another song</button>
                  <button class="btn-solid-reg page-scroll" id="submit-data">Submit</button>
                  <form>
                    <label for="song-data" font-size="2rem">Enter data:</label>
                    <input type="" value="" id="song-data"><br>
                  </form>
                </div>
              </div> <!-- end of container -->
            </div> <!-- end of tab-pane -->
            <!-- end of tab -->

            <!-- Tab -->
            <div class="tab-pane fade" id="tab-2" role="tabpanel" aria-labelledby="tab-2">
              <div class="container">
                <div id="oauth">
                </div>
                <div id="options">
                </div>
              </div> <!-- end of container -->
            </div> <!-- end of tab-pane -->
            <!-- end of tab -->

            <!-- Tab -->
            <div class="tab-pane fade" id="tab-3" role="tabpanel" aria-labelledby="tab-3">
              <div class="container">
                <div id="super-users">
                </div> <!-- end of container -->
              </div><!-- end of tab-pane -->
              <!-- end of tab -->

            </div> <!-- end of tab-content -->
            <!-- end of tabs content -->

          </div> <!-- end of row -->
        </div> <!-- end of container -->
      </div> <!-- end of tabs -->
    </div>
    <!-- end of features -->



    <!-- Footer -->
    <div class="footer">
      <div class="container">
        <div class="row">
          <div class="col-lg-13">
            <div class="footer-col first">
              <h6>About Crowdify</h6>
              <p class="p-small">Crowidify allows you to search songs in Spotify based on their lyrics, themes and more.
                Each user can contribute to our database, it's easy! You can just fill a query about your recenetly
                heard songs, or you can play in our specially designed games and earn points, every contribution will
                help to future users and is much appreciated.</p>
            </div> <!-- end of footer-col -->
            <div class="footer-col second">
              <h6>Links</h6>
              <ul class="list-unstyled li-space-lg p-small">
                <li>Important: <a href="terms.html">Terms & Conditions</a>, <a href="privacy.html">Privacy Policy</a>
                </li>
                <li>Useful: <a href="#">Colorpicker</a>, <a href="#">Icon Library</a>, <a href="#">Illustrations</a>
                </li>
                <li>Menu: <a href="article.html">Article</a>, <a href="features.html">Features</a>, <a
                    href="pricing.html">Pricing</a>, <a href="contact.html">Contact</a></li>
              </ul>
            </div> <!-- end of footer-col -->
            <div class="footer-col third">
              <span class="fa-stack">
                <a href="#your-link">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-facebook-f fa-stack-1x"></i>
                </a>
              </span>
              <span class="fa-stack">
                <a href="#your-link">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-twitter fa-stack-1x"></i>
                </a>
              </span>
              <span class="fa-stack">
                <a href="#your-link">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-pinterest-p fa-stack-1x"></i>
                </a>
              </span>
              <span class="fa-stack">
                <a href="#your-link">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-instagram fa-stack-1x"></i>
                </a>
              </span>
              <p class="p-small">We would love to hear from you <a
                  href="mailto:contactcrowdify@gmail.com"><strong>contactcrowdify@gmail.com</strong></a></p>
            </div> <!-- end of footer-col -->
          </div> <!-- end of col -->
        </div> <!-- end of row -->
      </div> <!-- end of container -->
    </div> <!-- end of footer -->
    <!-- end of footer -->


    <!-- Copyright -->
    <div class="copyright">
      <div class="container">
        <div class="row">
          <div class="col-lg-13">
            <p class="p-small">Copyright © Team Crowdify</p>
          </div> <!-- end of col -->
        </div> <!-- enf of row -->
      </div> <!-- end of container -->
    </div> <!-- end of copyright -->
    <!-- end of copyright -->




    <script id="user-profile-template" type="text/x-handlebars-template">
      <div class="row">
        <div class="col-lg-12">
            <div class="image-container">
                <img class="img-fluid" src="{{image_url}}" alt="alternative">
            </div> <!-- end of image-container -->
        </div> <!-- end of col -->
        <div class="col-lg-8">
            <div class="text-container">
                <h3>Please enter a signficant word to describe the song: </h3><h7>"{{songname}}"</h7><br><h7>By</h7><br><h7>{{artist}}</h7>
                
                <!--<a class="btn-solid-reg page-scroll" href="#download">Download</a>-->
            </div> <!-- end of text-container -->
        </div> <!-- end of col -->
    </div> <!-- end of row -->
    </script>

    <script id="suggested-words-template" type="text/x-handlebars-template">
      <div class="row">
        <div class="col-lg-12">
            <div class="image-container">
                <img class="img-fluid" src="{{image_url}}" alt="alternative">
            </div> <!-- end of image-container -->
        </div> <!-- end of col -->
        <div class="col-lg-8">
            <h5>You can also pick from this list:</h5>
            <ul class="list-unstyled li-space-lg">
              <li class="media-body">
                  <button class="btn-solid-reg page-scroll" id="option_1">{{option_1}}</button>
              </li>
              <li class="media-body">
                  <button class="btn-solid-reg page-scroll" id="option_2">{{option_2}}</button>
              </li>
              <li class="media">
                  <button class="btn-solid-reg page-scroll" id="option_3">{{option_3}}</button>
              </li>
            </ul>
            
        </div> <!-- end of col -->
    </div> <!-- end of row -->
    </script>

    <script id="super-users-template" type="text/x-handlebars-template">
      <div class="row">
        <div class="col-lg-6">
          <h4> These are the Top Contributers to Crowdify: </h5>
          <ul class="list-unstyled li-space-lg">
            <li class="media">
              <th id = "user_1">{{user_1}}</th>
            </li>
            <li class="media">
              <th id = "user_2">{{user_2}}</th>
            </li>
            <li class="media">
              <th id = "user_3">{{user_3}}</th>
            </li>
          </ul>
        </div>
        <div class="col-lg-6" text-align="center">
          <h6>One day, your name can appear on this list! Each of our contributers has our endless gratitude, let's continue to make this platform better, together.</h6>
        </div>
      </div>
    </script>


    <!-- Scripts -->
    <script src="js/jquery.min.js"></script> <!-- jQuery for Bootstrap's JavaScript plugins -->
    <script src="js/bootstrap.min.js"></script> <!-- Bootstrap framework -->
    <script src="js/jquery.easing.min.js"></script> <!-- jQuery Easing for smooth scrolling between anchors -->
    <script src="js/swiper.min.js"></script> <!-- Swiper for image and text sliders -->
    <script src="js/jquery.magnific-popup.js"></script> <!-- Magnific Popup for lightboxes -->
    <script src="js/morphext.min.js"></script> <!-- Morphtext rotating text in the header -->
    <script src="js/scripts.js"></script> <!-- Custom scripts -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/personalgame.js"></script>

    <script>

      /* *******************************************  Vriables ********************************************* */
      
      var userID;
      var songID;
      var popularity;
      var username;
      var name; /*song name*/
      var artist;

      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      var optionsSource = document.getElementById('suggested-words-template').innerHTML,
        optionsTemplate = Handlebars.compile(optionsSource),
        optionsPlaceholder = document.getElementById('options');

      var superusersSource = document.getElementById('super-users-template').innerHTML,
        superusersTemplate = Handlebars.compile(superusersSource),
        superusersPlaceholder = document.getElementById('super-users');
        
      /* *************************************************************************************************** */
      
      /* ************************************** Auxiliary Functions **************************************** */

      /**
       * @param window url
       * @return hash parameters- dictionary of parameters
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      /**
       * @param url for ajax
       * @param data for ajax
       * @param async boolean option for ajax
       * @return ajax response from the specified url
       */
      function call_ajax(url, data, async) {
        let res;
        
        $.ajax({
          url: url,
          data: data,
          async: false,
          success: function (response) {
            
            res = response;
          }
        });
        return res;
      }

      /**
       * @param words to render (the offers list for a given song)
       * @param image url for the song
       * @return no return value. render the options for the current queried song
       */
      function render_offers(words, image_url)
      {
        var len = words.lenght;
        var options;
        
        if (len == 0) {
          options = { option_1: "-", option_2: "-", option_3: "-", image_url: image_url };
          document.getElementById('option_1').style.display = "none";
          document.getElementById("option_2").style.display = "none";
          document.getElementById("option_3").style.display = "none";
        }
        if (len == 1) {
          options = { option_1: words[0], option_2: "-", option_3: "-", image_url: image_url };
          document.getElementById("option_2").style.display = "none";
          document.getElementById("option_3").style.display = "none";
        }
        if (len == 2) {
          options = { option_1: words[0], option_2: words[1], option_3: "-", image_url: image_url };
          document.getElementById("option_3").style.display = "none";
        }
        else {
          options = { option_1: words[0], option_2: words[1], option_3: words[2], image_url: image_url };
        }
            
        optionsPlaceholder.innerHTML = optionsTemplate(options); /*render options*/
      }
      
      /* *************************************************************************************************** */
      
      var params = getHashParams(); /*get parameters from url*/
      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;
      
      if (error) {
        alert('There was an error during the authentication');
      } else {

        if (access_token) {
  
          $.ajax({ /*init user_id and user_name*/
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            async: false,
            success: function (response) {
              userID = response.id;
              username = response.display_name;
              if(userID == undefined)
              {
                $('#login').show();
                $('#loggedin').hide();
              }
            }
          });
          
          /* ********** Get Song Data for Random Position in the Recently Played Tracks List ***************** */
          
          var pos = Math.floor((Math.random() * 10 + 1));
          var song_data = call_ajax('\\song_render',
            { 'pos': pos, access_token: access_token },
            false);
         
          userProfilePlaceholder.innerHTML = userProfileTemplate(song_data);
          songID = song_data.songID;
          popularity = song_data.popularity;
          name = song_data.songname;
          artist = song_data.artist;
          let words;
          
          /* ************************************************************************************************* */
          
          /* ******************************** Get Offers for the Current Song ******************************** */
          
          var offers = call_ajax('\\get_offers',
            { songID: songID, name: name, views: popularity, artist: artist },
            false);
          
          words = offers.words;
          render_offers(words, song_data.image_url);
          
          /* ************************************************************************************************* */
          
          /* ************************************** Render Super-Users *************************************** */
          
          var super_users;
          super_users = call_ajax('\\get_superusers', {}, false).super_users;
          var users = { user_1: super_users[0]['username'], user_2: super_users[0]['username'], user_3: super_users[0]['username'] };
          //var users = { user_1: super_users[0]['username'], user_2: super_users[1]['username'], user_3: super_users[2]['username'] };
          superusersPlaceholder.innerHTML = superusersTemplate(users);
          
          /* ************************************************************************************************* */

          /* ************************************* Event Listeners ******************************************* */
          document.getElementById('pick-new-song').addEventListener('click', function () {

            pos = Math.floor((Math.random() * 10 + 1));
            var song_data = call_ajax('\\song_render',
              { 'pos': pos, access_token: access_token },
              false);
            
            userProfilePlaceholder.innerHTML = userProfileTemplate(song_data);
            songID = song_data.songID;
            popularity = song_data.popularity;
            name = song_data.songname;
            let words;

            var offers = call_ajax('\\get_offers',
              { songID: songID, name: name, views: popularity, artist: artist },
              false);
              words = offers.words;
              render_offers(words, song_data.image_url);
          }, false);

          document.getElementById('submit-data').addEventListener('click', function (req, res) {
            let word = document.getElementById("song-data").value;

            call_ajax('\\word',
              {
                userID: userID, songID: songID, username: username,
                name: name, views: popularity, word: word
              }, false);
              document.getElementById("song-data").value = "";
          });

          document.getElementById("option_1").addEventListener('click', function (req, res) {
            let word = document.getElementById("option_1").innerHTML;
            alert("Here");
            call_ajax('\\word',
              {
                userID: userID, songID: songID, username: username,
                name: name, views: popularity, word: word
              }, false);
            
          });

          document.getElementById("option_2").addEventListener('click', function (req, res) {
            let word = document.getElementById("option_2").innerHTML;
            alert("Here");
            call_ajax('\\word',
              {
                userID: userID, songID: songID, username: username,
                name: name, views: popularity, word: word
              }, false);
           
          });

          document.getElementById("option_3").addEventListener('click', function (req, res) {
            let word = document.getElementById("option_3").innerHTML;
            alert("Here");
            call_ajax('\\word',
              {
                userID: userID, songID: songID, username: username,
                name: name, views: popularity, word: word
              }, false);
            
          }, false);
          /* ************************************************************************************************* */


        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();
        }
      }
    </script>
</body>

</html>